<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinecraftæœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢</title>
    <style>
        /* CSSå˜é‡å®šä¹‰ */
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --container-bg: white;
            --container-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --status-bg: #f9f9f9;
            --border-color: #eee;
            --address-color: #666;
            --players-bg: #e8f5e9;
            --online-color: #4CAF50;
            --offline-color: #f44336;
            --error-color: #f44336;
            --loading-color: #2196F3;
            --toggle-bg: rgba(255, 255, 255, 0.8);
            --toggle-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* æ·±è‰²æ¨¡å¼å˜é‡ */
        body.dark-mode {
            --bg-color: #242424;
            --text-color: #e0e0e0;
            --container-bg: #333333;
            --container-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            --status-bg: #404040;
            --border-color: #555555;
            --address-color: #b0b0b0;
            --players-bg: #2a4339;
            --error-color: #ef5350;
            --loading-color: #64b5f6;
            --toggle-bg: rgba(60, 60, 60, 0.8);
            --toggle-shadow: 0 2px 5px rgba(255, 255, 255, 0.1);
            --toggle-text-color: #ffffff;
        }
        
        /* åŸºç¡€æ ·å¼ */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        h1, h2 {
            margin-bottom: 20px;
        }
        
        h1 {
            color: var(--text-color);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--container-shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        #server-status {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--status-bg);
            transition: background-color 0.3s ease;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: var(--online-color);
        }
        
        .status-offline {
            background-color: var(--offline-color);
        }
        
        .server-info {
            margin: 10px 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }
        
        .server-info:last-child {
            border-bottom: none;
        }
        
        .server-address {
            color: var(--address-color);
            font-style: italic;
            margin: 5px 0;
            transition: color 0.3s ease;
        }
        
        .players {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--players-bg);
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .error {
            color: var(--error-color);
            font-weight: bold;
            transition: color 0.3s ease;
        }
        
        .loading {
            color: var(--loading-color);
            font-style: italic;
            transition: color 0.3s ease;
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        #theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            background-color: var(--toggle-bg);
            color: var(--text-color);
            box-shadow: var(--toggle-shadow);
            transition: all 0.3s ease;
            z-index: 1000;
            border: none;
            outline: none;
        }
        
        #theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode #theme-toggle {
            color: var(--toggle-text-color);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            #theme-toggle {
                top: 10px;
                right: 10px;
                font-size: 20px;
                padding: 8px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 20px;
            }
            
            .server-info {
                padding-bottom: 10px;
                margin-bottom: 10px;
            }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <button id="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    <main class="container">
        <h1>MinecraftæœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢</h1>
        <section id="server-status">
            <div class="loading">æ­£åœ¨æŸ¥è¯¢æœåŠ¡å™¨çŠ¶æ€...</div>
        </section>
    </main>

    <script>
        // é…ç½®å’Œå¸¸é‡
        const config = {
            servers: [
                { ip: 's6.ungc.com.cn', port: '15120', name: 'ç«¥è¯é•‡' },
                { ip: 'mc.fnzjaq.me', port: '25565', name: 'ä½ ä¹Ÿæ¥ğŸ±ğŸŸä¹ˆ' }
            ],
            apiBase: 'https://motd.minebbs.com/api/status',
            cacheDuration: 60 * 1000, // 1åˆ†é’Ÿç¼“å­˜
            autoRefreshInterval: 30 * 1000, // 30ç§’è‡ªåŠ¨åˆ·æ–°
            maxRetries: 3 // æœ€å¤§é‡è¯•æ¬¡æ•°
        };

        // DOMå…ƒç´ 
        const themeToggle = document.getElementById('theme-toggle');
        const serverStatusSection = document.getElementById('server-status');

        // ç¼“å­˜ç®¡ç†
        const cache = {
            data: {},
            
            get(key) {
                const item = this.data[key];
                if (!item) return null;
                if (Date.now() - item.timestamp > config.cacheDuration) {
                    delete this.data[key];
                    return null;
                }
                return item.value;
            },
            
            set(key, value) {
                this.data[key] = { value, timestamp: Date.now() };
            }
        };

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function initThemeToggle() {
            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = 'â˜€ï¸';
            }

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            themeToggle.addEventListener('click', () => {
                const isDarkMode = document.body.classList.toggle('dark-mode');
                themeToggle.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
                localStorage.setItem('darkMode', isDarkMode);
            });
        }

        // è½¬æ¢Minecrafté¢œè‰²ä»£ç ä¸ºHTML
        function convertMinecraftColors(motd) {
            if (!motd) return '';
            
            // æå–MOTDæ–‡æœ¬
            let motdText = '';
            if (typeof motd === 'object' && motd !== null) {
                if (motd.text) {
                    motdText = motd.text;
                } else if (motd.extra && Array.isArray(motd.extra)) {
                    // å¤„ç†å¸¦æœ‰extraå­—æ®µçš„å¤æ‚JSONç»“æ„
                    motdText = motd.extra.map(part => {
                        if (typeof part === 'object' && part.text) {
                            return part.text;
                        }
                        return String(part);
                    }).join('');
                } else {
                    motdText = JSON.stringify(motd);
                }
            } else {
                motdText = String(motd);
            }
            
            // é¢œè‰²ä»£ç æ˜ å°„
            const colorMap = {
                '0': '#000000', '1': '#0000AA', '2': '#00AA00', '3': '#00AAAA',
                '4': '#AA0000', '5': '#AA00AA', '6': '#FFAA00', '7': '#AAAAAA',
                '8': '#555555', '9': '#5555FF', 'a': '#55FF55', 'b': '#55FFFF',
                'c': '#FF5555', 'd': '#FF55FF', 'e': '#FFFF55', 'f': '#FFFFFF'
            };
            
            // æ ¼å¼ä»£ç æ˜ å°„
            const formatMap = {
                'l': 'font-weight: bold;',
                'm': 'text-decoration: line-through;',
                'n': 'text-decoration: underline;',
                'o': 'font-style: italic;'
            };
            
            // æµ…è‰²æ–‡æœ¬åˆ—è¡¨ï¼ˆåœ¨ç™½è‰²èƒŒæ™¯ä¸Šéœ€è¦æ·±è‰²é˜´å½±ï¼‰
            const lightColors = ['7', 'e', 'f'];
            
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–é¢œè‰²ä»£ç å¤„ç†
            return motdText.replace(/Â§([0-9a-frlmno])/g, (match, code) => {
                if (code === 'r') return '</span>';
                if (colorMap[code]) {
                    // ä¸ºæµ…è‰²æ–‡æœ¬æ·»åŠ æ·±è‰²é˜´å½±ä»¥æé«˜å¯è¯»æ€§
                    if (lightColors.includes(code)) {
                        return `<span style="color: ${colorMap[code]}; text-shadow: 0 0 2px #000000, 0 0 2px #000000;">`;
                    }
                    return `<span style="color: ${colorMap[code]};">`;
                }
                if (formatMap[code]) return `<span style="${formatMap[code]}">`;
                return match;
            });
        }

        // è·å–æœåŠ¡å™¨åœ°å€æ˜¾ç¤ºæ–‡æœ¬
        function getServerAddressDisplay(ip, port) {
            return port === '25565' ? ip : `${ip}:${port}`;
        }

        // æŸ¥è¯¢å•ä¸ªæœåŠ¡å™¨çŠ¶æ€ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        async function fetchServerStatus(server, retryCount = 0) {
            const cacheKey = `${server.ip}:${server.port}`;
            const cached = cache.get(cacheKey);
            
            if (cached) {
                return { ...cached, server };
            }

            try {
                const params = new URLSearchParams({
                    ip: server.ip,
                    port: server.port,
                    stype: 'auto',
                    string: encodeURIComponent('æœåŠ¡å™¨çŠ¶æ€')
                });
                
                const response = await fetch(`${config.apiBase}?${params}`);
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                }
                
                const data = await response.json();
                cache.set(cacheKey, data);
                return { ...data, server };
            } catch (error) {
                if (retryCount < config.maxRetries) {
                    // é‡è¯•è¯·æ±‚
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
                    return fetchServerStatus(server, retryCount + 1);
                }
                return { status: 'error', server, error: 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨' };
            }
        }

        // æŸ¥è¯¢æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€
        async function fetchAllServersStatus() {
            try {
                const results = await Promise.all(config.servers.map(fetchServerStatus));
                displayServerStatus(results);
            } catch (error) {
                serverStatusSection.innerHTML = '<div class="error">æŸ¥è¯¢æœåŠ¡å™¨çŠ¶æ€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }

        // æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€
        function displayServerStatus(results) {
            let html = '';
            
            results.forEach(data => {
                const { server } = data;
                const { ip, port } = server;
                const addressDisplay = getServerAddressDisplay(ip, port);
                
                if (data.status === 'online') {
                    const { players, version } = data;
                    
                    // æŸ¥æ‰¾MOTD
                    let rawMotd = '';
                    const motdFields = ['description', 'motd', 'rawMotd', 'pureMotd', 'htmlMotd'];
                    for (const field of motdFields) {
                        if (data.hasOwnProperty(field)) {
                            rawMotd = data[field];
                            break;
                        }
                    }
                    
                    const serverMOTD = convertMinecraftColors(rawMotd);
                    
                    html += `
                        <article class="server-info">
                            <h2>
                                <span class="status-indicator status-online"></span>
                                ${server.name}
                            </h2>
                            <p class="server-address"><strong>åœ°å€:</strong> ${addressDisplay}</p>
                            <p><strong>çŠ¶æ€:</strong> åœ¨çº¿</p>
                            <p><strong>MOTD:</strong> ${serverMOTD || 'æ— '}</p>
                            <p><strong>ç‰ˆæœ¬:</strong> ${version || 'æœªçŸ¥'}</p>
                            <div class="players">
                                <p><strong>ç©å®¶:</strong> ${players.online}/${players.max} åœ¨çº¿</p>
                            </div>
                        </article>
                    `;
                } else {
                    html += `
                        <article class="server-info">
                            <h2>
                                <span class="status-indicator status-offline"></span>
                                ${server.name}
                            </h2>
                            <p class="server-address"><strong>åœ°å€:</strong> ${addressDisplay}</p>
                            <p><strong>çŠ¶æ€:</strong> ${data.status === 'error' ? 'æŸ¥è¯¢å¤±è´¥' : 'ç¦»çº¿'}</p>
                            ${data.error ? `<p class="error"><strong>é”™è¯¯:</strong> ${data.error}</p>` : ''}
                        </article>
                    `;
                }
            });
            
            serverStatusSection.innerHTML = html;
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            initThemeToggle();
            serverStatusSection.innerHTML = '<div class="loading">æ­£åœ¨æŸ¥è¯¢æœåŠ¡å™¨çŠ¶æ€...</div>';
            fetchAllServersStatus();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            setInterval(() => {
                fetchAllServersStatus();
            }, config.autoRefreshInterval);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

